# syntax=docker/dockerfile:1.7-labs

###############################
# Frontend build stage        #
###############################
FROM docker.io/library/node:22 AS frontend-builder
WORKDIR /app/frontend

ARG VITE_API_BASE_URL=/api
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}

COPY frontend/package.json frontend/package-lock.json ./
RUN npm ci

COPY frontend/ ./
# Use the podman-specific environment file .env.podman which has TURNSTILE keys etc.
RUN npm run build -- --mode podman

###############################
# Django + Gunicorn stage     #
###############################
FROM docker.io/library/python:3.13-slim AS backend
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1

RUN apt-get update \
    && apt-get install --no-install-recommends -y build-essential libpq-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY backend /app
COPY --from=frontend-builder /app/frontend/dist /app/frontend_dist

RUN pip install --upgrade pip \
    && pip install --no-cache-dir --root-user-action=ignore .

ENV DJANGO_SETTINGS_MODULE=notsolong.settings.prod \
    DJANGO_SECRET_KEY=build-stage-secret \
    DATABASE_URL=sqlite:////app/build.sqlite3 \
    FRONTEND_DIST_DIR=/app/frontend_dist \
    PORT=1111

RUN python manage.py collectstatic --noinput

RUN chmod +x scripts/entrypoint.sh

EXPOSE 1111
CMD ["/app/scripts/entrypoint.sh"]
